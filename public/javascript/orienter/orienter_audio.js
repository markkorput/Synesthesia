// Generated by CoffeeScript 1.6.3
(function() {
  this.OrienterAudio = (function() {
    function OrienterAudio(opts) {
      var bufferLoader,
        _this = this;
      this.options = opts || {};
      this.track_urls = ['audio/drone.wav', 'audio/125bpm-drums.wav', 'audio/techno.wav'];
      this.volume = 0.6;
      this.freq = 700;
      this.gainMultiplier = 1.0;
      if (typeof webkitAudioContext !== "undefined") {
        this.context = new webkitAudioContext();
      } else if (typeof AudioContent !== "undefined") {
        this.context = new AudioContext();
      } else {
        console.log("AudioContext not supported");
        return;
      }
      this.gain = this.context.createGain();
      this.gain.gain.value = this.volume * this.gainMultiplier;
      this.gain.connect(this.context.destination);
      this.filter = this.context.createBiquadFilter();
      this.filter.connect(this.gain);
      this.filter.type = this.filter.LOWPASS;
      this.filter.frequency.value = 5000;
      this.filter.Q.value = 15;
      bufferLoader = new BufferLoader(this.context, this.track_urls, function(bufferList) {
        return _this.bufferList = bufferList;
      });
      bufferLoader.load();
    }

    OrienterAudio.prototype.applyTempo = function(val) {
      console.log('apply tempo', val);
      if (this.source) {
        return this.source.playbackRate.value = val;
      }
    };

    OrienterAudio.prototype.applyGain = function(val) {
      return this.setGain(val);
    };

    OrienterAudio.prototype.applyRadar = function(val) {
      return this._radarTempo = val;
    };

    OrienterAudio.prototype.start = function(trckidx) {
      var buffer;
      if (!this.context) {
        return;
      }
      if (!this.bufferList) {
        console.log('no buffer list');
        return;
      }
      this.stop();
      console.log(trckidx);
      if (trckidx === false) {
        return;
      }
      if (trckidx === void 0 || trckidx === true) {
        trckidx = this._trackIdx || 0;
      }
      buffer = this.bufferList[trckidx];
      if (!buffer) {
        console.log('invalid buffer');
        return;
      }
      this.source = this.context.createBufferSource();
      this.source.buffer = buffer;
      this.source.loop = true;
      this.source.connect(this.filter);
      return this.source.start(this.context.currentTime);
    };

    OrienterAudio.prototype.stop = function() {
      if (this.source) {
        this.source.stop(this.context.currentTime);
        this.source.disconnect();
        return this.source = void 0;
      }
    };

    OrienterAudio.prototype.isPlaying = function() {
      return this.source !== void 0;
    };

    OrienterAudio.prototype.setVolume = function(vol) {
      this.volume = vol;
      if (this.gain) {
        return this.gain.gain.value = vol * (1.0 - this.fade);
      }
    };

    OrienterAudio.prototype.setGain = function(g) {
      this.gainMultiplier = Math.max(Math.min(g, 1.0), 0.0);
      if (this.gain) {
        return this.gain.gain.value = this.volume * this.gainMultiplier;
      }
    };

    OrienterAudio.prototype.update = function(frameCount) {
      var gain, sinpos;
      if (this._radarTempo) {
        if (this._radarTempo === 0) {
          gain = 1;
        } else {
          sinpos = new Date().getTime() * (1 / this._radarTempo);
          gain = Math.sin(sinpos) / 2 + 0.75;
        }
        return this.setGain(gain * gain);
      }
    };

    OrienterAudio.prototype.setTrack = function(tracknumber) {
      this._trackIdx = tracknumber - 1;
      if (this.isPlaying()) {
        return this.start();
      }
    };

    return OrienterAudio;

  })();

}).call(this);
