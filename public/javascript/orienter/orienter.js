// Generated by CoffeeScript 1.6.3
(function() {
  var Orienter,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $(document).ready(function() {
    return window.orienter = new Orienter();
  });

  Orienter = (function() {
    function Orienter(opts) {
      this.onDeviceAccel = __bind(this.onDeviceAccel, this);
      this.onDeviceMotion = __bind(this.onDeviceMotion, this);
      var _this = this;
      this.options = opts || {};
      this.server = io.connect('/orienter');
      this.$h1 = $('h1');
      this.session_el = $('#session_id');
      this.orientation_el = $('#orientation');
      this.acceleration_el = $('#acceleration');
      this.target_el = $('#target');
      this.current_el = $('#current');
      this.distance_el = $('#distance');
      this.currentVal = 0;
      this.targetVal = 0;
      this.server.on('sessionId', function(data) {
        _this.session_id = data;
        return _this.session_el.text('Session ID: ' + data);
      });
      this.server.on('welcome', function(data) {
        if (data.tracking) {
          return _this.setupTracking();
        } else {
          return _this.$h1.text('Connected. Motion tracking off.');
        }
      });
      this.server.on('reset', function() {
        return _this.setupTracking(false);
      });
      this.server.on('toggleMotion', function(data) {
        if (data.motion) {
          return _this.setupTracking();
        } else {
          return _this.setupTracking(false);
        }
      });
      this.server.on('targetOrientationValue', function(data) {
        if (data.sessionId !== _this.session_id) {
          return;
        }
        _this.targetVal = data.value;
        _this.target_el.text('Target: ' + _this.targetVal);
        return _this.updateDistance();
      });
      this.twoEl = document.getElementById('anim');
      this.two = new Two({
        fullscreen: true
      }).appendTo(this.twoEl);
      this.c1 = this.two.makeCircle(0, 0, Math.min(this.two.width * 0.3, this.two.height * 0.3));
      this.c1.translation.set(this.two.width / 2, this.two.height / 2);
      this.c1.fill = 'black';
      this.c1.noStroke();
      this.c1.opacity = 0.5;
      this.circle = this.two.makeCircle(0, -Math.min(this.two.width * 0.3, this.two.height * 0.3), 10);
      this.circle.fill = 'red';
      this.circle.noStroke();
      this.rotator = this.two.makeGroup(this.circle);
      this.rotator.translation.set(this.two.width / 2, this.two.height / 2);
      this.two.play();
    }

    Orienter.prototype.setupTracking = function(_setup) {
      this.setupMotionListener(_setup);
      this.setupAccelListener(_setup);
      if (_setup === true || _setup === void 0) {
        return this.$h1.text('Now tracking motion.');
      } else {
        return this.$h1.text('Motion tracking off.');
      }
    };

    Orienter.prototype.setupMotionListener = function(_setup) {
      if (_setup === true || _setup === void 0) {
        return window.addEventListener('deviceorientation', this.onDeviceMotion);
      } else {
        return window.removeEventListener('deviceorientation', this.onDeviceMotion);
      }
    };

    Orienter.prototype.setupAccelListener = function(_setup) {
      if (_setup === true || _setup === void 0) {
        return window.addEventListener('devicemotion', this.onDeviceAccel);
      } else {
        return window.removeEventListener('devicemotion', this.onDeviceAccel);
      }
    };

    Orienter.prototype.onDeviceMotion = function(event) {
      this.server.emit('motionData', {
        alpha: event.alpha,
        beta: event.beta,
        gamma: event.gamma
      });
      this.orientation_el.text('Orientation: ' + [event.alpha, event.beta, event.gamma].join(', '));
      this.currentVal = Math.floor(event.alpha || 0);
      this.current_el.text('Current: ' + this.currentVal);
      return this.updateDistance();
    };

    Orienter.prototype.onDeviceAccel = function(event) {
      this.server.emit('accelerationData', {
        rotationRate: event.rotationRate,
        acceleration: event.acceleration,
        accelerationIncludingGravity: event.accelerationIncludingGravity
      });
      return this.acceleration_el.text('Acceleration: ' + [event.accelerationIncludingGravity.x, event.accelerationIncludingGravity.y, event.accelerationIncludingGravity.z].join(', '));
    };

    Orienter.prototype.updateDistance = function() {
      var a, b, dist;
      if (this.currentVal === void 0 || this.targetVal === void 0) {
        return;
      }
      this.rotator.rotation = (this.currentVal - this.targetVal) / 180 * Math.PI;
      a = this.targetVal;
      if (this.targetVal > 180) {
        a = 180 - (this.targetVal - 180);
      }
      b = this.currentVal;
      if (this.currentVal > 180) {
        b = 180 - (this.currentVal - 180);
      }
      dist = a - b;
      return this.distance_el.text('Delta: ' + Math.abs(dist));
    };

    return Orienter;

  })();

}).call(this);
